<!DOCTYPE html>
<html lang="en" class="light">

<title>Nginx Virtual Host for redirecting non-www to www and HTTPS | ResetGoToMain</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="In the past I had some problems with wrong redirections of my websites with the nginx webserver. Either the non-www to www or the redirect to the HTTPS versi...">
<meta name="author" content="">
<meta name="generator" content="Jekyll v3.7.4">
<link rel="canonical" href="http://localhost:4000/nginx-virtual-host-for-redirecting-non-www-to-www-and-https/">
<link rel="stylesheet" href="/assets/css/index.css">
<link rel="stylesheet" href="/assets/css/minimal.css">
<link rel="alternate" type="application/atom+xml" href="/feed.xml" title="ResetGoToMain" />




<header class="">
  
    <h1>
      <a href="/">
<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" id="svg4751" version="1.1" viewBox="0 0 44.612904 11.288884" height="39.999985" width="158.07722">
  <defs id="defs4745"></defs>
  <metadata id="metadata4748">
    <rdf:rdf>
      <cc:work rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"></dc:type>
        <dc:title></dc:title>
      </cc:work>
    </rdf:rdf>
  </metadata>
  <g transform="translate(163.72879,-160.62724)" id="layer1">
    <rect y="160.85565" x="-142.23767" height="10.832061" width="22.893372" id="rect4701" style="fill: #ffffff;fill-opacity:1;fill-rule:nonzero;stroke: #ff4747;stroke-width:0.4568232;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1;"></rect>
    <g transform="matrix(0.22456131,0,0,0.22456131,-126.96164,133.31041)" id="text5332-3" style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:semi-condensed;font-size:55.73048782px;line-height:1.25;font-family:'Nimbus Sans Narrow';-inkscape-font-specification:'Nimbus Sans Narrow, Bold Semi-Condensed';text-align:start;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:0.26458332" aria-label="2M">
      <path id="path4574" style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:55.73183441px;font-family:'Roboto Slab';-inkscape-font-specification:'Roboto Slab, Bold';text-align:start;letter-spacing:5.29166651px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#a6e22e;fill-opacity:1;stroke-width:0.26458332" d="m -63.187293,166.87737 0,-5.19765 12.817233,-13.74247 q 2.775707,-3.1839 3.945858,-5.36092 1.170151,-2.20424 1.170151,-4.08193 0,-2.50357 -1.360641,-4.08192 -1.333428,-1.60555 -3.809793,-1.60555 -2.748494,0 -4.190773,1.87768 -1.415066,1.85047 -1.415066,4.95273 l -7.728438,0 -0.05443,-0.16327 q -0.136064,-5.36093 3.510453,-9.06187 3.673729,-3.72815 9.87825,-3.72815 6.122882,0 9.633334,3.18389 3.510453,3.1839 3.510453,8.4904 0,3.59209 -1.986535,6.63993 -1.959323,3.04783 -6.531075,7.94614 l -7.048117,7.70122 0.05443,0.13607 10.286442,0 0.326554,-3.91865 6.041244,0 0,10.01432 z"></path>
      <path id="path4576" style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:55.73183441px;font-family:'Roboto Slab';-inkscape-font-specification:'Roboto Slab, Bold';text-align:start;letter-spacing:5.29166651px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#a6e22e;fill-opacity:1;stroke-width:0.26458332" d="m 10.680656,137.56917 -0.163277,-0.0272 -10.61299566,29.33541 -5.33371074,0 -10.5585706,-29.22656 -0.163276,0.0272 0.761958,17.38899 0,6.23173 4.245199,0.81638 0,4.76225 -16.409325,0 0,-4.76225 4.217986,-0.81638 0,-28.43739 -4.217986,-0.81638 0,-4.78946 4.217986,0 10.36808,0 10.0959527,29.19935 0.1632769,0 10.1775909,-29.19935 14.6404915,0 0,4.78946 -4.245198,0.81638 0,28.43739 4.245198,0.81638 0,4.76225 -16.4093242,0 0,-4.76225 4.2179855,-0.81638 0,-6.23173 z"></path>
    </g>
    <text id="text5312" y="163.33746" x="-204.20137" style="font-style:normal;font-weight:normal;font-size:2.85192847px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.26458332" xml:space="preserve"><tspan style="font-size:2.85192847px;stroke-width:0.26458332" y="163.33746" x="-204.20137" id="tspan5310"></tspan></text>
    <flowroot transform="matrix(0.22456131,0,0,0.22456131,-126.96164,133.31041)" style="font-style:normal;font-weight:normal;font-size:40px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;fill:#000000;fill-opacity:1;stroke:none" id="flowRoot5322" xml:space="preserve"><flowregion id="flowRegion5324"><rect y="-23.194601" x="-2094.2856" height="925.71429" width="2105.7144" id="rect5326"></rect></flowregion><flowpara id="flowPara5328"></flowpara></flowroot>    <g transform="matrix(0.22456131,0,0,0.22456131,-126.96164,133.31041)" id="text5332-2" style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:semi-condensed;font-size:55.73048782px;line-height:1.25;font-family:'Nimbus Sans Narrow';-inkscape-font-specification:'Nimbus Sans Narrow, Bold Semi-Condensed';text-align:start;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.26458332" aria-label="2M"></g>
    <path id="rect853" d="m -163.72879,160.62724 21.38946,0 0,11.28888 -21.38946,0 z" style="opacity:1;fill: #ff4747;fill-opacity:1;stroke:none;stroke-width:0;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1;"></path>
    <g transform="matrix(0.22456131,0,0,0.22456131,-126.96164,133.31041)" id="text5332" style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:semi-condensed;font-size:55.73048782px;line-height:1.25;font-family:'Nimbus Sans Narrow';-inkscape-font-specification:'Nimbus Sans Narrow, Bold Semi-Condensed';text-align:start;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:0.26458332" aria-label="RG">
      <path id="path4637" style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:55.7318306px;font-family:'Roboto Slab';-inkscape-font-specification:'Roboto Slab, Bold';text-align:start;letter-spacing:5.29166651px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#a6e22e;fill-opacity:1;stroke-width:0.26458332" d="m -136.5332,126.96977 q 6.74878,0 10.58578,3.10226 3.83701,3.07504 3.83701,8.5176 0,2.99341 -1.60556,5.19765 -1.60555,2.20424 -4.70781,3.56488 3.51045,1.03409 5.03437,3.45603 1.55113,2.39472 1.55113,5.9596 l 0,2.01375 q 0,1.30621 0.51704,2.04096 0.51704,0.70753 1.71441,0.8436 l 0.97966,0.13606 0,4.78945 -4.10914,0 q -3.89143,0 -5.46977,-2.09538 -1.57834,-2.09539 -1.57834,-5.41535 l 0,-2.25866 q 0,-2.88456 -1.55113,-4.51733 -1.52392,-1.65998 -4.32684,-1.74162 l -6.50386,0 0,10.44972 4.2452,0.81638 0,4.76224 -16.40933,0 0,-4.76224 4.21799,-0.81638 0,-28.43739 -4.21799,-0.81638 0,-4.78945 4.21799,0 z m -5.63305,17.47062 5.49699,0 q 3.31996,0 4.97994,-1.41507 1.65998,-1.41506 1.65998,-4.08192 0,-2.66685 -1.65998,-4.2452 -1.63277,-1.60555 -4.84388,-1.60555 l -5.63305,0 z"></path>
      <path id="path4639" style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:55.7318306px;font-family:'Roboto Slab';-inkscape-font-specification:'Roboto Slab, Bold';text-align:start;letter-spacing:5.29166651px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#a6e22e;fill-opacity:1;stroke-width:0.26458332" d="m -77.877218,162.18314 q -1.932109,1.9049 -5.633051,3.45603 -3.700942,1.52391 -9.361206,1.52391 -8.027775,0 -13.062145,-5.36092 -5.03437,-5.38814 -5.03437,-13.98738 l 0,-1.36064 q 0,-8.89859 4.95273,-14.47722 4.97994,-5.57862 12.980508,-5.57862 4.653391,0 8.490396,1.4967 3.864219,1.46949 6.422223,4.00028 l 0,7.97336 -5.877966,0 -1.115726,-5.3065 q -1.088512,-0.92524 -2.884557,-1.46949 -1.768833,-0.57147 -4.081921,-0.57147 -5.197647,0 -8.082207,3.837 -2.88455,3.83701 -2.88455,10.04153 l 0,1.41507 q 0,6.04124 2.83013,9.66054 2.830129,3.59209 8.163839,3.59209 2.394728,0 3.864219,-0.40819 1.496705,-0.40819 2.340302,-0.95245 l 0,-6.72156 -5.660264,-0.43541 0,-5.57862 13.633616,0 z"></path>
    </g>
    <g transform="matrix(0.07953213,0,0,0.18943295,-122.27338,146.1826)" id="text5332-3-7" style="font: bold semi-condensed 55.7305px/1.25 &quot;Nimbus Sans Narrow&quot;; text-align: start; letter-spacing: 0px; word-spacing: 0px; writing-mode: lr-tb; text-anchor: start; fill: rgb(40, 40, 40); fill-opacity: 1; stroke: none; stroke-width: 0.484059; display: inline;" aria-label="|">
      <path id="path4571" style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:55.73183441px;font-family:'Roboto Slab';-inkscape-font-specification:'Roboto Slab, Bold';text-align:start;letter-spacing:5.29166651px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#282828;fill-opacity:1;stroke-width:0.48405907" d="m 22.523473,129.8719 -4.762242,0 0,-46.969314 4.762242,0 z"></path>
    </g>
  </g>
</svg>

    </a>
    </h1>
  
  
    <nav>
    
      
        <a href="/">Home</a>
      
    
      
        <a href="/references/">References</a>
      
    
      
        <a href="/about/">About</a>
      
    
      
        <a href="/impressum/">Impressum</a>
      
    
    </nav>
  
  
    <nav>
    
      <a class="icon" href="mailto:denis@resetgotomain.de" target="_blank"><svg><use xlink:href="/assets/fontawesome/icons.svg#envelope"></use></svg></a>
    
      <a class="icon" href="https://github.com/DenisLug" target="_blank"><svg><use xlink:href="/assets/fontawesome/icons.svg#github"></use></svg></a>
    
      <a class="icon" href="/feed.xml" target="_blank"><svg><use xlink:href="/assets/fontawesome/icons.svg#rss"></use></svg></a>
    
    </nav>
  
</header>

<article>
  <header><h1><a href="/nginx-virtual-host-for-redirecting-non-www-to-www-and-https/">Nginx Virtual Host for redirecting non-www to www and HTTPS</a></h1>
    <time datetime="2018-11-09T00:00:00+01:00">November 09, 2018</time>
  </header>
<p>In the past I had some problems with wrong redirections of my websites with the nginx webserver. Either the non-www to www or the redirect to the HTTPS version of my site didn’t worked. I figured out the problems with the help of others and some for myself and would like to show you how your virtual hosts should look like to prevent any random redirections. We desire that all requests without HTTPS or the www prefix (<em>example.com</em>) gets redirected to its counterpart (<em>https://www.example.com</em>).</p>

<p>At first we need to pickup all requests which address the unencrypted HTTP port 80. The server name should be here the www as well as the non-www version of your domain. Then we will make a redirect to the desired domain with www prefix and HTTPS included.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">server <span class="o">{</span>
    listen         80<span class="p">;</span>
    listen    <span class="o">[</span>::]:80<span class="p">;</span>
    server_name    example.com  www.example.com<span class="p">;</span>
    <span class="k">return         </span>301 https://www.example.com<span class="nv">$request_uri</span><span class="p">;</span>
<span class="o">}</span></code></pre></figure>

<p>Now there is the possibility to call the site over HTTPS but to omit the www prefix. Here we are listening at the HTTPS port for the non-www version and redirect it to the desired format. Note that we need to include here our certificates to be able to accept the connection. In this case I have included my <a href="https://letsencrypt.org/">Let’s Encrypt</a> certificate.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">server <span class="o">{</span>
    listen         443 ssl http2<span class="p">;</span>
    server_name    example.com<span class="p">;</span>

    ssl_certificate     /etc/letsencrypt/live/example.com/fullchain.pem<span class="p">;</span>
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem<span class="p">;</span>

    <span class="k">return         </span>301 https://www.example.com<span class="nv">$request_uri</span><span class="p">;</span>
<span class="o">}</span></code></pre></figure>

<p>For the last part there is only the main server block left for our desired URL format. This block listens for an incoming HTTPS request from a with a www prefixed URL. The user have typed the URL in the right format and triggered this block or more likely the block has been triggered by an redirection of one of our server blocks above. Include again here your certifactes and additional configurations by Let’s Encrypt. After this you can handle your main actions for your locations. I have added here some additions for restricting my Wordpress backend, for processing the PHP and a small block when my images, JS and CSS files should expire at.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">server <span class="o">{</span>
    listen        443 ssl http2 default_server<span class="p">;</span>
    listen   <span class="o">[</span>::]:443 ssl http2 default_server<span class="p">;</span>

    root /var/www/example.com<span class="p">;</span>
    index index.php index.html index.htm<span class="p">;</span>

    server_name www.example.com<span class="p">;</span>

    ssl_certificate     /etc/letsencrypt/live/example.com/fullchain.pem<span class="p">;</span>
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem<span class="p">;</span>
    include             /etc/letsencrypt/options-ssl-nginx.conf<span class="p">;</span>
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem<span class="p">;</span>

    client_max_body_size 32M<span class="p">;</span>

    location / <span class="o">{</span>
        try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ /index.php?q<span class="o">=</span><span class="nv">$uri</span>&amp;<span class="nv">$args</span><span class="p">;</span>
    <span class="o">}</span>

    location /wp-admin <span class="o">{</span>
        auth_basic <span class="s2">"Restricted"</span><span class="p">;</span>
        auth_basic_user_file /var/www/.htpasswd<span class="p">;</span>
        try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ /index.php?q<span class="o">=</span><span class="nv">$uri</span>&amp;<span class="nv">$args</span><span class="p">;</span>
    <span class="o">}</span>

    location ~ <span class="se">\.</span>php<span class="nv">$ </span><span class="o">{</span>
        try_files <span class="nv">$uri</span> <span class="o">=</span>404<span class="p">;</span>
        fastcgi_split_path_info ^<span class="o">(</span>.+<span class="se">\.</span>php<span class="o">)(</span>/.+<span class="o">)</span><span class="nv">$;</span>
        fastcgi_pass unix:/run/php/php7.2-fpm.sock<span class="p">;</span>
        fastcgi_index index.php<span class="p">;</span>
        fastcgi_param SCRIPT_FILENAME <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
        include fastcgi_params<span class="p">;</span>
    <span class="o">}</span>

    <span class="c"># cache control</span>
    location ~<span class="k">*</span> <span class="se">\.</span><span class="o">(</span>jpg|jpeg|png|gif|ico|css|js<span class="o">)</span><span class="nv">$ </span><span class="o">{</span>
        expires 7d<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  
  
</article>


<footer>
  <a class="gray" href="/control-kodi-with-tasker-and-amazfit-bip/">« Control Kodi with Tasker and Amazfit BIP</a>
  <a class="gray" href="/my-i3-config/">My i3 config »</a>
</footer>




<script type="text/javascript">
  function startBlinking() {
    setInterval(function () {
      blink();
    }, 1000);
  }
  function blink() {
    // note no timeout for the hiding part
    document.getElementById('text5332-3-7').style.display = "none";
    setTimeout(function () {
      document.getElementById('text5332-3-7').style.display = "inline";
    }, 500);
  }

  startBlinking();
</script>

</html>
